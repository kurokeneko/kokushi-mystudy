<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å›½è©¦mystudyğŸˆ</title>

<style>
/* ===== å…¨ä½“è¨­å®š ===== */
:root {
  --primary-color: #4a90e2;    /* è½ã¡ç€ã„ãŸé’ */
  --accent-color: #4caf50;     /* å®Œäº†ãƒ»æˆåŠŸã®ç·‘ */
  --bg-color: #f8f9fa;         /* èƒŒæ™¯ã®è–„ã„ã‚°ãƒ¬ãƒ¼ */
  --sidebar-bg: #ffffff;       /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ç™½ */
  --border-color: #e0e0e0;     /* å¢ƒç•Œç·š */
  --text-main: #333333;        /* ãƒ¡ã‚¤ãƒ³æ–‡å­—è‰² */
  --text-sub: #666666;         /* è£œåŠ©æ–‡å­—è‰² */
}

body {
  margin: 0;
  font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
  display: flex;
  height: 100vh;
  overflow: hidden;
  background-color: var(--bg-color);
  color: var(--text-main);
}

/* ===== ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆå…±é€šï¼‰ ===== */
.toolbar-global {
  position: sticky;
  top: 0;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(4px);
  border-bottom: 1px solid var(--border-color);
  padding: 12px 20px;
  z-index: 1000;
  display: flex;
  gap: 8px;
}

button {
  cursor: pointer;
  border: 1px solid var(--border-color);
  background: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 14px;
  transition: all 0.2s;
  color: var(--text-main);
}

button:hover {
  background: #f0f7ff;
  border-color: var(--primary-color);
  color: var(--primary-color);
}

/* ===== ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆç›®æ¬¡ï¼‰ ===== */
#toc {
  width: 300px;
  border-right: 1px solid var(--border-color);
  padding: 20px;
  background: var(--sidebar-bg);
  overflow-y: auto;
  box-shadow: 2px 0 5px rgba(0,0,0,0.02);
}

#toc h2 {
  font-size: 1.2rem;
  margin-bottom: 15px;
  color: var(--primary-color);
  display: flex;
  align-items: center;
  gap: 8px;
}

#searchBox, #filterStatus {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-size: 14px;
  box-sizing: border-box;
}

#searchBox:focus {
  outline: 2px solid var(--primary-color);
  border-color: transparent;
}

.toc-main {
  font-weight: bold;
  margin-top: 20px;
  padding: 8px;
  background: #f0f4f8;
  border-left: 4px solid var(--primary-color);
  border-radius: 0 4px 4px 0;
}

.toc-sub {
  margin-left: 10px;
  margin-top: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  padding: 8px;
  border-radius: 6px;
  font-size: 0.95rem;
}

/* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
/* å¤§é …ç›®ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«å°é …ç›®ã‚’éš ã™ãŸã‚ã®è¨­å®š */
.dragging-main-mode .toc-sub {
  display: none !important;
}


.dragging {
  opacity: 0.3;
}



.toc-sub:hover {
  background: #f9f9f9;
}

/* ãƒ‰ãƒ­ãƒƒãƒ—å…ˆã®éš™é–“ã‚’ç¤ºã™ãƒ©ã‚¤ãƒ³ï¼ˆé›†ä¸­ã‚’å¦¨ã’ãªã„ç·‘è‰²ï¼‰ */
.drag-over-top {
  border-top: 3px solid var(--accent-color) !important;
}
.drag-over-bottom {
  border-bottom: 3px solid var(--accent-color) !important;
}


/* ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ===== */
#content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: white;
}

#main {
  flex: 1;
  padding: 30px 40px;
  overflow-y: auto;
}

.main-title {
  font-size: 1.8rem;
  font-weight: 800;
  margin-top: 40px;
  margin-bottom: 20px;
  border-bottom: 2px solid var(--text-main);
  padding-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* å°é …ç›®ãƒœãƒƒã‚¯ã‚¹ï¼ˆã‚«ãƒ¼ãƒ‰é¢¨ï¼‰ */
.sub-box {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 0;
  margin-top: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  overflow: hidden;
}

.sub-header {
  background: #fafafa;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.editor {
  padding: 20px;
  min-height: 150px;
  line-height: 1.8; /* èª­ã¿ã‚„ã™ã•ã®ãŸã‚ã«åºƒã‚ã« */
  font-size: 16px;
  color: #444;
}

/* ===== è¡¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãƒãƒ¼ãƒˆé¢¨ï¼‰ ===== */
table {
  border-collapse: collapse;
  width: 100%;
  margin: 15px 0;
  background: white;
}

th, td {
  border: 1px solid #d1d1d1;
  padding: 10px;
  font-size: 15px;
}

th {
  background: #f2f2f2;
}

/* ===== è¡¨ç·¨é›†ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆä¸Šéƒ¨å›ºå®šãƒãƒ¼å½¢å¼ï¼‰ ===== */
.table-toolbar {
  background: #444; /* ã‚°ãƒ¬ãƒ¼ã§åŒºåˆ¥ */
  padding: 8px 20px;
  border-bottom: 1px solid var(--border-color);
  display: none; /* JSã§flexã«åˆ‡ã‚Šæ›¿ãˆ */
  gap: 8px;
  align-items: center;
  z-index: 999;
}

.table-toolbar button {
  background: #555;
  color: white;
  border: 1px solid #666;
  font-size: 12px;
  padding: 4px 10px;
  min-width: auto;
}

.table-toolbar button:hover {
  background: var(--primary-color);
  border-color: var(--primary-color);
}


</style>
</head>

<body>



<div id="toc">
  <button onclick="undo()">â†©</button>
<button onclick="redo()">â†ª</button>
  <h2>ç›®æ¬¡</h2>
  <input id="searchBox" placeholder="ğŸ” æ¤œç´¢" oninput="render()">


    <select id="filterStatus" onchange="render()" style="width: 100%; padding: 6px; margin-bottom: 6px;">
    <option value="all">ã™ã¹ã¦</option>
    <option value="done">å®Œäº†ã®ã¿</option>
    <option value="todo">æœªå®Œäº†ã®ã¿</option>
  </select>

  <button onclick="exportJSON()">ğŸ“¤ JSON</button>
  <button onclick="importJSON()">ğŸ“¥ èª­è¾¼</button>
  <input type="file" id="jsonInput" accept=".json" hidden>

  <hr>
  <button onclick="addMain()">ï¼‹ å¤§é …ç›®</button>
  <div id="tocList"></div>
</div>

<div id="content">
<div id="editorToolbar" class="toolbar-global">
  <button onclick="cmd('bold')">å¤ªå­—</button>
  <button onclick="cmd('underline')">ä¸‹ç·š</button>
  <button onclick="insertTable()">è¡¨</button>
</div>

<script>
  // æŒ¿å…¥å ´æ‰€ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ç›´å‰ã®è¦ç´ ã®ã‚ã¨ã«é…ç½®ã—ã¾ã™
  document.addEventListener("DOMContentLoaded", () => {
    const editorToolbar = document.getElementById("editorToolbar");
    const tableToolbar = document.createElement("div");
    tableToolbar.id = "tableToolbar";
    tableToolbar.className = "table-toolbar";
    tableToolbar.style.display = "none";
    tableToolbar.innerHTML = `
      <button onclick="moveRow(-1)">â¬† è¡Œ</button>
      <button onclick="moveRow(1)">â¬‡ è¡Œ</button>
      <button onclick="moveCol(-1)">â¬… åˆ—</button>
      <button onclick="moveCol(1)">â¡ åˆ—</button>
      <span style="color:#666; margin: 0 8px;">|</span>
      <button onclick="addRow()">è¡Œï¼‹</button>
      <button onclick="addCol()">åˆ—ï¼‹</button>
      <button onclick="delRow()">è¡Œâˆ’</button>
      <button onclick="delCol()">åˆ—âˆ’</button>
    `;
    editorToolbar.parentNode.insertBefore(tableToolbar, editorToolbar.nextSibling);
  });
</script>


<div id="main"></div>
</div>



<script>
/* =====================
   åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ç®¡ç†
===================== */
const KEY = "kokushi-my-study";
let data = JSON.parse(localStorage.getItem(KEY)) || [];

/* =====================
   undo / redo ç”¨å±¥æ­´
===================== */
let history = [];
let historyIndex = -1;

function snapshot() {
  history = history.slice(0, historyIndex + 1);
  history.push(JSON.stringify(data));
  historyIndex++;
}

function save() {
  snapshot();
  localStorage.setItem(KEY, JSON.stringify(data));
}

function saveRaw() {
  localStorage.setItem(KEY, JSON.stringify(data));
  render();
}

/* åˆæœŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ */
snapshot();

/* =====================
   å¤§é …ç›®ãƒ»å°é …ç›®
===================== */
function addMain() {
  const t = prompt("å¤§é …ç›®å");
  if (!t) return;
  data.push({ title: t, subs: [] });
  save(); render();
}

function addSub(mi) {
  const t = prompt("å°é …ç›®å");
  if (!t) return;
  data[mi].subs.push({ title: t, html: "", checked: false, open: true });
  save(); render();
}

/* =====================
   å‰Šé™¤
===================== */
function deleteMain(mi) {
  if (!confirm(`ã€Œ${data[mi].title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆä¸­ã®å°é …ç›®ã‚‚å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`)) return;
  data.splice(mi, 1);
  save(); render();
}

function deleteSub(mi, si) {
  if (!confirm(`ã€Œ${data[mi].subs[si].title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  data[mi].subs.splice(si, 1);
  save(); render();
}

/* =====================
   æç”»
===================== */
function render() {
  const toc = document.getElementById("tocList");
  const main = document.getElementById("main");
    const kw = document.getElementById("searchBox").value.toLowerCase();
  const filter = document.getElementById("filterStatus").value; // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å€¤ã‚’å–å¾—

  toc.innerHTML = main.innerHTML = "";

  data.forEach((m, mi) => {
    let hitMain = false;
    const subsDom = [];

    const subsDomForToc = [];
    m.subs.forEach((s, si) => {
      const matchesKeyword = !kw || (s.title + s.html).toLowerCase().includes(kw);
      const matchesFilter = (filter === "all") || (filter === "done" && s.checked) || (filter === "todo" && !s.checked);
      if (!matchesKeyword || !matchesFilter) return;

      hitMain = true;
      const id = `sub-${mi}-${si}`;

      // ç›®æ¬¡ç”¨ã®å°é …ç›®ä½œæˆ
      const tocSub = document.createElement("div");
      tocSub.className = "toc-sub";
      tocSub.draggable = true;
      tocSub.style.cursor = "grab";
      tocSub.ondragstart = (e) => {
        e.dataTransfer.setData("text/plain", JSON.stringify({ type: 'sub', mi, si }));
        tocSub.classList.add("dragging");
        e.stopPropagation();
      };
      tocSub.ondragend = () => tocSub.classList.remove("dragging");

      const checkSpan = document.createElement("span");
      checkSpan.textContent = s.checked ? "â˜‘" : "â˜";
      checkSpan.style.color = s.checked ? "#4caf50" : "#999";
      checkSpan.style.fontSize = "1.5em";
      checkSpan.style.marginRight = "10px";
      checkSpan.style.display = "inline-block";
      
      const titleSpan = document.createElement("span");
      titleSpan.textContent = s.title;
      titleSpan.style.color = s.checked ? "#888" : "inherit";
      
      tocSub.append(checkSpan, titleSpan);
      tocSub.onclick = (e) => {
        if (e.target === checkSpan) {
          s.checked = !s.checked;
          save(); render();
        } else {
          const target = document.getElementById(id);
          if (target) target.scrollIntoView({ behavior: 'smooth' });
        }
      };
      subsDomForToc.push(tocSub);

      // æœ¬æ–‡ç”¨ã®å°é …ç›®ä½œæˆ
      const box = document.createElement("div");
      box.className = "sub-box";
      box.id = id;
      const header = document.createElement("div");
      header.className = "sub-header";
      const title = document.createElement("span");
      title.textContent = s.title;
      const del = document.createElement("button");
      del.textContent = "ğŸ—‘";
      del.onclick = e => { e.stopPropagation(); deleteSub(mi, si); };
      header.append(title, del);
      header.onclick = e => {
        if (e.altKey) {
          const t = prompt("å°é …ç›®åã‚’å¤‰æ›´", s.title);
          if (t) { s.title = t; save(); render(); }
        } else {
          s.open = !s.open; save(); render();
        }
      };
      const editor = document.createElement("div");
      editor.className = "editor";
      editor.contentEditable = true;
      editor.innerHTML = s.html;
      editor.oninput = () => { s.html = editor.innerHTML; save(); };
      editor.onfocus = () => { activeEditor = editor; };
      if (!s.open) editor.style.display = "none";
      box.append(header, editor);
      subsDom.push(box);
    });


        // ç›®æ¬¡ã¨æœ¬æ–‡ã®ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºï¼ˆæ¤œç´¢æ¡ä»¶ã«åˆã†å ´åˆã®ã¿ï¼‰
    if (hitMain || !kw) {
                  

            // --- å·¦å´ã®ç›®æ¬¡ï¼ˆå¤§é …ç›®ï¼‰ã‚’è¿½åŠ  ---
      const tmToc = document.createElement("div");
      tmToc.className = "toc-main";
      tmToc.style.cursor = "grab"; // æ´ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚«ãƒ¼ã‚½ãƒ«
      tmToc.textContent = m.title;
      tmToc.draggable = true; // ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«
      
      // å¤§é …ç›®ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      tmToc.ondragstart = (e) => {
        e.dataTransfer.setData("text/plain", JSON.stringify({ type: 'main', mi }));
        tmToc.classList.add("dragging");
        // ç›®æ¬¡å…¨ä½“ã‚’ã€Œå¤§é …ç›®ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ã€ã«ã™ã‚‹
        document.getElementById("toc").classList.add("dragging-main-mode");
      };
      tmToc.ondragend = () => {
        tmToc.classList.remove("dragging");
        // ãƒ¢ãƒ¼ãƒ‰è§£é™¤
        document.getElementById("toc").classList.remove("dragging-main-mode");
      };


            // å¤§é …ç›®ã®å‹•ä½œï¼šã‚¯ãƒªãƒƒã‚¯ã§è©²å½“ç®‡æ‰€ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      tmToc.onclick = () => {
        const target = Array.from(main.querySelectorAll('.main-title')).find(el => el.textContent.includes(m.title));
        if (target) target.scrollIntoView({ behavior: 'smooth' });
      };

      toc.appendChild(tmToc);

      // --- å·¦å´ã®ç›®æ¬¡ï¼ˆå°é …ç›®ï¼‰ã‚’è¿½åŠ  ---
      subsDomForToc.forEach(el => toc.appendChild(el));



      // --- å³å´ã®æœ¬æ–‡ã‚¨ãƒªã‚¢ã®æç”»é–‹å§‹ ---


      const mt = document.createElement("div");
mt.className = "main-title";

const title = document.createElement("span");
title.textContent = m.title;

const del = document.createElement("button");
del.textContent = "ğŸ—‘";
del.style.marginLeft = "8px";
del.onclick = (e) => {
  e.stopPropagation(); // ã“ã‚Œã«ã‚ˆã‚Šè¦ªè¦ç´ (mt)ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆåå‰å¤‰æ›´ï¼‰ãŒç™ºç”Ÿã™ã‚‹ã®ã‚’é˜²ãã¾ã™
  deleteMain(mi);
};

mt.append(title, del);


mt.onclick = () => {
  const t = prompt("å¤§é …ç›®åã‚’å¤‰æ›´", m.title);
  if (!t) return;
  m.title = t;
  save(); render();
};

main.append(mt);

      const btn = document.createElement("button");
      btn.textContent = "ï¼‹ å°é …ç›®";
      btn.onclick = () => addSub(mi);
      main.append(btn);

      subsDom.forEach(d => main.append(d));
    }
  });
}

/* =====================
   ã‚¨ãƒ‡ã‚£ã‚¿æ“ä½œ
===================== */
 function cmd(c) {
  if (!activeEditor) return;
  activeEditor.focus();
  document.execCommand(c);
}

function insertTable() {
  if (!activeEditor) return;
  activeEditor.focus();

  const html = `
    <table>
      <tr><td contenteditable="true"></td><td contenteditable="true"></td></tr>
      <tr><td contenteditable="true"></td><td contenteditable="true"></td></tr>
    </table>`;
  document.execCommand("insertHTML", false, html);
}

/* =====================
   ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ä¸¦ã¹æ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
===================== */
document.addEventListener("DOMContentLoaded", () => {
  const tocList = document.getElementById("tocList");

    // ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’æ¶ˆå»ã™ã‚‹å…±é€šå‡¦ç†
  const clearDragStyles = () => {
    tocList.querySelectorAll(".drag-over-top, .drag-over-bottom").forEach(el => {
      el.classList.remove("drag-over-top", "drag-over-bottom");
    });
  };

  tocList.ondragover = (e) => {
    e.preventDefault();
    const target = e.target.closest(".toc-main, .toc-sub");
    clearDragStyles();
    if (target) {
      const rect = target.getBoundingClientRect();
      // ãƒã‚¦ã‚¹ãŒè¦ç´ ã®åŠåˆ†ã‚ˆã‚Šä¸‹ã«ã‚ã‚‹ã‹åˆ¤å®š
      const isBottom = e.clientY - rect.top > rect.height / 2;
      target.classList.add(isBottom ? "drag-over-bottom" : "drag-over-top");
    }
  };

  tocList.ondragleave = clearDragStyles;

  tocList.ondrop = (e) => {
    e.preventDefault();
    const target = e.target.closest(".toc-main, .toc-sub");
    clearDragStyles();

    const rawData = e.dataTransfer.getData("text/plain");
    if (!rawData) return;
    const dragData = JSON.parse(rawData);

    // åŠåˆ†ã‚ˆã‚Šä¸‹ãªã‚‰ã€Œç›´å¾Œã€ã«æŒ¿å…¥ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°
    let isAfter = false;
    if (target) {
      const rect = target.getBoundingClientRect();
      isAfter = e.clientY - rect.top > rect.height / 2;
    }

    // --- å¤§é …ç›®ã®ä¸¦ã¹æ›¿ãˆ ---
    if (dragData.type === 'main') {
      const movedItem = data.splice(dragData.mi, 1)[0];
      // ã“ã®æ™‚ç‚¹ã§ã¯å°é …ç›®ãŒæ¶ˆãˆã¦ã„ã‚‹ã®ã§ã€toc-mainã ã‘ã‚’æ•°ãˆã‚Œã°è‰¯ã„
      const allMainEls = Array.from(tocList.querySelectorAll(".toc-main"));
      let targetIdx = target ? allMainEls.indexOf(target) : data.length;
      
      if (isAfter && target) targetIdx++;
      
      // è‡ªåˆ†ã®å…ƒã®ä½ç½®ã‚ˆã‚Šå¾Œã‚ã«æŒã£ã¦ã„ãå ´åˆã¯ã€spliceã§è©°ã¾ã£ãŸåˆ†ã‚’èª¿æ•´
      const finalIdx = targetIdx > dragData.mi ? targetIdx - 1 : targetIdx;
      data.splice(Math.max(0, finalIdx), 0, movedItem);
    } 

    // --- å°é …ç›®ã®ç§»å‹• ---
    else if (dragData.type === 'sub') {
      const movedSub = data[dragData.mi].subs.splice(dragData.si, 1)[0];
      let tMainIdx = 0;
      let tSubIdx = -1;

      if (target) {
        // 1. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒå°é …ç›®ã®å ´åˆ
        data.forEach((m, mi) => {
          const si = m.subs.findIndex(s => s.title === (target.querySelector("span:last-child")?.textContent || "").trim());
          if (si !== -1) {
            tMainIdx = mi;
            tSubIdx = isAfter ? si + 1 : si;
          }
        });

        // 2. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒå¤§é …ç›®ã®å ´åˆ
        if (tSubIdx === -1) {
          tMainIdx = data.findIndex(m => m.title === target.textContent.trim());
          tSubIdx = isAfter ? data[tMainIdx].subs.length : 0;
        }
      }
      
      // æŒ¿å…¥å®Ÿè¡Œ
      if (tSubIdx === -1) {
        data[tMainIdx].subs.push(movedSub);
      } else {
        data[tMainIdx].subs.splice(tSubIdx, 0, movedSub);
      }
    }

    save();
    render();
  };

});


/* =====================
   JSONå…¥å‡ºåŠ›
===================== */
function exportJSON() {
  const b = new Blob([JSON.stringify(data, null, 2)]);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(b);
  a.download = "kokushi-backup.json";
  a.click();
}

function importJSON() {
  jsonInput.click();
}

jsonInput.onchange = e => {
  const r = new FileReader();
  r.onload = () => {
    data = JSON.parse(r.result);
    snapshot();
    saveRaw();
  };
  r.readAsText(e.target.files[0]);
};

/* =====================
   è¡¨æ“ä½œï¼ˆé¸æŠç®¡ç†ï¼‰
===================== */
let activeTable = null;
let activeCell = null;
let activeEditor = null;

document.addEventListener("click", e => {
  const toolbar = document.getElementById("tableToolbar");
  if (!toolbar) return;
  const cell = e.target.closest("td, th");

  if (cell) {
    activeCell = cell;
    activeTable = cell.closest("table");
    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§ã¯ãªãä¸Šéƒ¨ã«å›ºå®šè¡¨ç¤º
    toolbar.style.display = "flex";
  } else {
    // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼å†…ã®ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯æ¶ˆã•ãªã„ã‚ˆã†ã«åˆ¤å®š
    if (!e.target.closest("#tableToolbar")) {
      toolbar.style.display = "none";
      activeCell = activeTable = null;
    }
  }
});

/* =====================
   è¡Œãƒ»åˆ— è¿½åŠ å‰Šé™¤
===================== */
function addRow() {
  if (!activeTable) return;
  const row = activeTable.insertRow();
  const cols = activeTable.rows[0].cells.length;
  for (let i = 0; i < cols; i++) row.insertCell().contentEditable = "true";
  save();
}

function addCol() {
  if (!activeTable) return;
  for (const r of activeTable.rows) r.insertCell().contentEditable = "true";
  save();
}

function delRow() {
  if (!activeTable || activeTable.rows.length <= 1) return;
  activeTable.deleteRow(-1);
  save();
}

function delCol() {
  if (!activeTable) return;
  const cols = activeTable.rows[0].cells.length;
  if (cols <= 1) return;
  for (const r of activeTable.rows) r.deleteCell(-1);
  save();
}

/* =====================
   è¡Œãƒ»åˆ— ç§»å‹•ï¼ˆâ‘¡â‘¢â‘¤â‘¥ï¼‰
===================== */
function moveRow(dir) {
  if (!activeCell || !activeTable) return;

  const row = activeCell.parentElement;
  const rows = Array.from(activeTable.rows);
  const index = rows.indexOf(row);

  // ä¸Šé™ãƒ»ä¸‹é™ãƒã‚§ãƒƒã‚¯
  if (dir === -1 && index === 0) return;
  if (dir === 1 && index === rows.length - 1) return;

  const targetIndex = index + dir;
  const reference =
    dir === -1
      ? rows[targetIndex]                  // ä¸Šã¸ â†’ å¯¾è±¡è¡Œã®å‰
      : rows[targetIndex].nextSibling;     // ä¸‹ã¸ â†’ å¯¾è±¡è¡Œã®ã€Œæ¬¡ã€

  activeTable.insertBefore(row, reference);
  save();
}

function moveCol(dir) {
  if (!activeCell) return;
  const row = activeCell.parentElement;
  const c = Array.from(row.cells).indexOf(activeCell);
  const t = c + dir;
  if (t < 0 || t >= row.cells.length) return;

  for (const r of activeTable.rows) {
    const cell = r.cells[c];
    const ref = r.cells[t];
    dir === -1
      ? r.insertBefore(cell, ref)
      : r.insertBefore(ref, cell);
  }
  save();
}

/* =====================
   undo / redoï¼ˆâ‘¦-â‘¤é™¤å¤–ï¼‰
===================== */
function undo() {
  if (historyIndex <= 0) return;
  historyIndex--;
  data = JSON.parse(history[historyIndex]);
  saveRaw();
}

function redo() {
  if (historyIndex >= history.length - 1) return;
  historyIndex++;
  data = JSON.parse(history[historyIndex]);
  saveRaw();
}

document.addEventListener("keydown", e => {
  if (e.key !== "Enter") return;

  const sel = window.getSelection();
  if (!sel.rangeCount) return;

  let node = sel.anchorNode;
  if (node.nodeType === 3) node = node.parentElement;

  const cell = node.closest("td, th");
  if (!cell) return;   // â† è¡¨å¤–ãªã‚‰å®Œå…¨ã‚¹ãƒ«ãƒ¼

  e.preventDefault();

// Shift + Enter â†’ ã‚»ãƒ«å†…æ”¹è¡Œï¼ˆç¢ºå®Ÿç‰ˆï¼‰
if (e.shiftKey) {
  const br = document.createElement("br");
  const range = sel.getRangeAt(0);

  range.deleteContents();
  range.insertNode(br);

  // ã‚­ãƒ£ãƒ¬ãƒƒãƒˆã‚’ <br> ã®å¾Œã‚ã¸
  range.setStartAfter(br);
  range.collapse(true);
  sel.removeAllRanges();
  sel.addRange(range);

  save();
  return;
}

  const row = cell.parentElement;
  const table = row.closest("table");
  const rows = Array.from(table.rows);
  const rowIndex = rows.indexOf(row);
  const colIndex = Array.from(row.cells).indexOf(cell);

  // æœ€ä¸‹è¡Œãªã‚‰æ–°è¦è¡Œè¿½åŠ 
  let targetRow;
  if (rowIndex === rows.length - 1) {
    targetRow = table.insertRow();
    for (let i = 0; i < row.cells.length; i++) {
      const c = targetRow.insertCell();
      c.contentEditable = "true";
      c.tabIndex = -1;
      c.innerHTML = "";
    }
  } else {
    targetRow = rows[rowIndex + 1];
  }

  const targetCell = targetRow.cells[colIndex];
  targetCell.tabIndex = -1;
  targetCell.focus();

  // ã‚­ãƒ£ãƒ¬ãƒƒãƒˆã‚’å…ˆé ­ã¸
  const range = document.createRange();
  range.selectNodeContents(targetCell);
  range.collapse(true);
  sel.removeAllRanges();
  sel.addRange(range);

  save();
});

/* =====================
   åˆæœŸæç”»
===================== */
render();
</script>
</body>
</html>