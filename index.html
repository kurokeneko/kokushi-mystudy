<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å›½è©¦ãƒã‚¤ã‚¹ã‚¿ãƒ‡ã‚£</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  display: flex;
  min-height: 100vh;
  overflow: hidden;
}

/* ===== ç›®æ¬¡ ===== */
#toc {
  width: 280px;
  border-right: 1px solid #ccc;
  padding: 10px;
  background: #f7f7f7;
  overflow-y: auto;
}

#toc h2 {
  margin-top: 0;
}

.toc-main {
  font-weight: bold;
  margin-top: 14px;
}

.toc-sub {
  margin-left: 14px;
  font-size: 0.95em;
  cursor: pointer;
  display: flex;
  align-items: center;
}

.toc-sub span {
  margin-right: 6px;
  font-size: 1.2em;
}

/* ===== æœ¬æ–‡ ===== */
#main {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
}

.main-title {
  font-size: 1.5em;
  margin-top: 28px;
}

.sub-box {
  border: 1px solid #ddd;
  padding: 10px;
  margin-top: 12px;
}

.sub-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}

.sub-header span {
  font-weight: bold;
  font-size: 1.05em;
}

.sub-content {
  margin-top: 10px;
}

.sub-content.hidden {
  display: none;
}

textarea {
  width: 100%;
  min-height: 120px;
  box-sizing: border-box;
  font-size: 1em;
  line-height: 1.5;
  resize: none;
}

button {
  cursor: pointer;
  font-size: 0.9em;
  margin-top: 4px;
}

#searchBox {
  width: 100%;
  box-sizing: border-box;
  margin: 6px 0;
  padding: 6px;
  font-size: 1em;
}
</style>
</head>

<body>

<div id="toc">
  <h2>ç›®æ¬¡</h2>

  <input id="searchBox" placeholder="ğŸ” æ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰" oninput="render()">

  <button onclick="exportJSON()">ğŸ“¤ JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button><br>
  <button onclick="importJSON()">ğŸ“¥ JSONèª­ã¿è¾¼ã¿</button>
  <input type="file" id="jsonInput" accept=".json" style="display:none"><br><br>

  <button onclick="addMain()">ï¼‹ å¤§é …ç›®</button>
  <div id="tocList"></div>
</div>

<div id="main"></div>

<script>
const STORAGE_KEY = "kokushi-my-study";
let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  render();
}

function addMain() {
  const title = prompt("å¤§é …ç›®åã‚’å…¥åŠ›");
  if (!title) return;
  data.push({ title, subs: [] });
  save();
}

function addSub(mainIndex) {
  const title = prompt("å°é …ç›®åã‚’å…¥åŠ›");
  if (!title) return;
  data[mainIndex].subs.push({
    title,
    text: "",
    checked: false,
    open: true
  });
  save();
}

function toggleCheck(mi, si) {
  data[mi].subs[si].checked = !data[mi].subs[si].checked;
  save();
}

function toggleOpen(mi, si) {
  data[mi].subs[si].open = !data[mi].subs[si].open;
  save();
}

function updateText(mi, si, textarea) {
  data[mi].subs[si].text = textarea.value;
  textarea.style.height = "auto";
  textarea.style.height = textarea.scrollHeight + "px";
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function scrollToSub(id) {
  document.getElementById(id)?.scrollIntoView({ behavior: "smooth" });
}

function render() {
  const toc = document.getElementById("tocList");
  const main = document.getElementById("main");
  const keyword = document.getElementById("searchBox").value.toLowerCase();

  toc.innerHTML = "";
  main.innerHTML = "";

  data.forEach((m, mi) => {
    let mainHasHit = false;

    /* ===== æœ¬æ–‡ï¼šå¤§é …ç›® ===== */
    const mainTitle = document.createElement("div");
    mainTitle.className = "main-title";
    mainTitle.textContent = m.title;

    const addSubBtn = document.createElement("button");
    addSubBtn.textContent = "ï¼‹ å°é …ç›®";
    addSubBtn.onclick = () => addSub(mi);

    const subBoxes = [];

    m.subs.forEach((s, si) => {
      const text = (s.title + s.text).toLowerCase();
      const hit = !keyword || text.includes(keyword);
      if (!hit) return;

      mainHasHit = true;
      const subId = `sub-${mi}-${si}`;

      /* --- ç›®æ¬¡ï¼šå°é …ç›® --- */
      const tocSub = document.createElement("div");
      tocSub.className = "toc-sub";
      tocSub.onclick = () => scrollToSub(subId);

      const checkIcon = document.createElement("span");
      checkIcon.textContent = s.checked ? "â˜‘" : "â˜";
      checkIcon.onclick = e => {
        e.stopPropagation();
        toggleCheck(mi, si);
      };

      const label = document.createElement("span");
      label.textContent = s.title;

      tocSub.appendChild(checkIcon);
      tocSub.appendChild(label);
      toc.appendChild(tocSub);

      /* --- æœ¬æ–‡ï¼šå°é …ç›® --- */
      const box = document.createElement("div");
      box.className = "sub-box";
      box.id = subId;

      const header = document.createElement("div");
      header.className = "sub-header";
      header.onclick = () => toggleOpen(mi, si);

      const titleSpan = document.createElement("span");
      titleSpan.textContent = (s.checked ? "â˜‘ " : "â˜ ") + s.title;

      const openSpan = document.createElement("span");
      openSpan.textContent = s.open ? "â–¼" : "â–¶";

      header.appendChild(titleSpan);
      header.appendChild(openSpan);

      const content = document.createElement("div");
      content.className = "sub-content" + (s.open ? "" : " hidden");

      const textarea = document.createElement("textarea");
      textarea.value = s.text;
      textarea.oninput = () => updateText(mi, si, textarea);
      setTimeout(() => updateText(mi, si, textarea));

      content.appendChild(textarea);
      box.appendChild(header);
      box.appendChild(content);
      subBoxes.push(box);
    });

    if (mainHasHit) {
      /* ===== ç›®æ¬¡ï¼šå¤§é …ç›® ===== */
      const tocMain = document.createElement("div");
      tocMain.className = "toc-main";
      tocMain.textContent = m.title;
      toc.appendChild(tocMain);

      main.appendChild(mainTitle);
      main.appendChild(addSubBtn);
      subBoxes.forEach(b => main.appendChild(b));
    }
  });
}

render();

/* ===== JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— ===== */
function exportJSON() {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const date = new Date().toISOString().slice(0,10);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `kokushi-backup-${date}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function importJSON() {
  document.getElementById("jsonInput").click();
}

document.getElementById("jsonInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      data = JSON.parse(reader.result);
      save();
      alert("èª­ã¿è¾¼ã¿å®Œäº†ï¼");
    } catch {
      alert("JSONãŒä¸æ­£ã§ã™");
    }
  };
  reader.readAsText(file);
});
</script>

</