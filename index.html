<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å›½è©¦ãƒã‚¤ã‚¹ã‚¿ãƒ‡ã‚£</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  display: flex;
  min-height: 100vh;
  overflow: hidden;
}

/* ===== ç›®æ¬¡ ===== */
#toc {
  width: 280px;
  border-right: 1px solid #ccc;
  padding: 10px;
  background: #f7f7f7;
  overflow-y: auto;
}

#toc h2 { margin-top: 0; }

.toc-main {
  font-weight: bold;
  margin-top: 14px;
}

.toc-sub {
  margin-left: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
}

.toc-sub span {
  margin-right: 6px;
  font-size: 1.3em;
}

/* ===== æœ¬æ–‡ ===== */
#main {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
}

.main-title {
  font-size: 1.5em;
  margin-top: 28px;
}

.sub-box {
  border: 1px solid #ddd;
  padding: 10px;
  margin-top: 12px;
}

.sub-header {
  display: flex;
  justify-content: space-between;
  cursor: pointer;
  font-weight: bold;
}

.editor {
  margin-top: 10px;
  border: 1px solid #ccc;
  padding: 8px;
  min-height: 120px;
  line-height: 1.6;
}

.editor:focus {
  outline: 2px solid #4caf50;
}

.toolbar button {
  font-size: 0.85em;
  margin-right: 6px;
}

table {
  border-collapse: collapse;
  margin: 8px 0;
}
td, th {
  border: 1px solid #666;
  padding: 6px;
  min-width: 60px;
}

#searchBox {
  width: 100%;
  padding: 6px;
  margin-bottom: 6px;
}

/* ===== è¡¨ç·¨é›† ===== */
.table-toolbar {
  position: fixed;
  background: #333;
  color: #fff;
  padding: 6px;
  border-radius: 6px;
  font-size: 12px;
  display: none;
  z-index: 9999;
}

.table-toolbar button {
  margin: 2px;
  font-size: 12px;
}

/* åˆ—å¹…ãƒ‰ãƒ©ãƒƒã‚° */
table {
  table-layout: fixed;
}

td, th {
  resize: horizontal;
  overflow: auto;
}

</style>
</head>

<body>

<div id="toc">
  <h2>ç›®æ¬¡</h2>
  <input id="searchBox" placeholder="ğŸ” æ¤œç´¢" oninput="render()">

  <button onclick="exportJSON()">ğŸ“¤ JSON</button>
  <button onclick="importJSON()">ğŸ“¥ èª­è¾¼</button>
  <input type="file" id="jsonInput" accept=".json" hidden>

  <hr>
  <button onclick="addMain()">ï¼‹ å¤§é …ç›®</button>
  <div id="tocList"></div>
</div>

<div id="main"></div>

<div id="tableToolbar" class="table-toolbar">
  <button onclick="addRow()">è¡Œï¼‹</button>
  <button onclick="addCol()">åˆ—ï¼‹</button>
  <button onclick="delRow()">è¡Œâˆ’</button>
  <button onclick="delCol()">åˆ—âˆ’</button>
</div>

<script>
const KEY = "kokushi-my-study";
let data = JSON.parse(localStorage.getItem(KEY)) || [];

function save() {
  localStorage.setItem(KEY, JSON.stringify(data));
}

function addMain() {
  const t = prompt("å¤§é …ç›®å");
  if (!t) return;
  data.push({ title: t, subs: [] });
  save(); render();
}

function addSub(mi) {
  const t = prompt("å°é …ç›®å");
  if (!t) return;
  data[mi].subs.push({ title: t, html: "", checked: false, open: true });
  save(); render();
}

function render() {
  const toc = document.getElementById("tocList");
  const main = document.getElementById("main");
  const kw = document.getElementById("searchBox").value.toLowerCase();
  toc.innerHTML = main.innerHTML = "";

  data.forEach((m, mi) => {
    let hitMain = false;
    const subsDom = [];

    m.subs.forEach((s, si) => {
      if (kw && !(s.title + s.html).toLowerCase().includes(kw)) return;
      hitMain = true;
      const id = `sub-${mi}-${si}`;

      const tocSub = document.createElement("div");
      tocSub.className = "toc-sub";
      tocSub.innerHTML = `<span>${s.checked ? "â˜‘" : "â˜"}</span>${s.title}`;
      tocSub.onclick = () => document.getElementById(id).scrollIntoView();
      toc.appendChild(tocSub);

      const box = document.createElement("div");
      box.className = "sub-box";
      box.id = id;

      const header = document.createElement("div");
      header.className = "sub-header";
      header.textContent = s.title;
      header.onclick = () => { s.open = !s.open; save(); render(); };

      const toolbar = document.createElement("div");
      toolbar.className = "toolbar";
      toolbar.innerHTML = `
        <button onclick="cmd('bold')">å¤ªå­—</button>
        <button onclick="cmd('underline')">ä¸‹ç·š</button>
        <button onclick="insertTable()">è¡¨</button>
      `;

      const editor = document.createElement("div");
      editor.className = "editor";
      editor.contentEditable = true;
      editor.innerHTML = s.html;
      editor.oninput = () => {
        s.html = editor.innerHTML;
        save();
      };

      editor.onkeydown = e => {
        if (e.metaKey && e.key === "r") { e.preventDefault(); cmd("bold"); }
        if (e.metaKey && e.key === "u") { e.preventDefault(); cmd("underline"); }
      };

      if (!s.open) editor.style.display = toolbar.style.display = "none";

      box.append(header, toolbar, editor);
      subsDom.push(box);
    });

    if (hitMain) {
      const tm = document.createElement("div");
      tm.className = "toc-main";
      tm.textContent = m.title;
      toc.appendChild(tm);

      const mt = document.createElement("div");
      mt.className = "main-title";
      mt.textContent = m.title;
      main.append(mt);

      const btn = document.createElement("button");
      btn.textContent = "ï¼‹ å°é …ç›®";
      btn.onclick = () => addSub(mi);
      main.append(btn);

      subsDom.forEach(d => main.append(d));
    }
  });
}

function cmd(c) {
  document.execCommand(c);
}

function insertTable() {
  const html = `
  <table>
    <tr><th></th><th></th></tr>
    <tr><td></td><td></td></tr>
  </table>`;
  document.execCommand("insertHTML", false, html);
}

function exportJSON() {
  const b = new Blob([JSON.stringify(data, null, 2)]);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(b);
  a.download = "kokushi-backup.json";
  a.click();
}

function importJSON() {
  jsonInput.click();
}

jsonInput.onchange = e => {
  const r = new FileReader();
  r.onload = () => {
    data = JSON.parse(r.result);
    save(); render();
  };
  r.readAsText(e.target.files[0]);
};

render();

let activeTable = null;

document.addEventListener("click", e => {
  const toolbar = document.getElementById("tableToolbar");

  if (e.target.closest("table")) {
    activeTable = e.target.closest("table");
    toolbar.style.display = "block";
    toolbar.style.top = e.clientY + 10 + "px";
    toolbar.style.left = e.clientX + 10 + "px";
  } else {
    toolbar.style.display = "none";
    activeTable = null;
  }
});

function addRow() {
  if (!activeTable) return;
  const row = activeTable.insertRow();
  const cols = activeTable.rows[0].cells.length;
  for (let i = 0; i < cols; i++) {
    row.insertCell().innerHTML = "";
  }
  save();
}

function addCol() {
  if (!activeTable) return;
  for (const row of activeTable.rows) {
    row.insertCell().innerHTML = "";
  }
  save();
}

function delRow() {
  if (!activeTable) return;
  if (activeTable.rows.length > 1) {
    activeTable.deleteRow(-1);
    save();
  }
}

function delCol() {
  if (!activeTable) return;
  const cols = activeTable.rows[0].cells.length;
  if (cols <= 1) return;
  for (const row of activeTable.rows) {
    row.deleteCell(-1);
  }
  save();
}
</script>
</body>
</html>