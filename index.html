<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å›½è©¦ãƒã‚¤ã‚¹ã‚¿ãƒ‡ã‚£</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  display: flex;
  min-height: 100vh;
  overflow: hidden;
}

/* ===== ç›®æ¬¡ ===== */
#toc {
  width: 240px;
  border-right: 1px solid #ccc;
  padding: 10px;
  background: #f7f7f7;
  overflow-y: auto;
}

#toc h2 {
  margin-top: 0;
}

.toc-main {
  font-weight: bold;
  margin-top: 12px;
}

.toc-sub {
  margin-left: 14px;
  font-size: 0.9em;
  cursor: pointer;
}

.toc-sub.checked {
  text-decoration: line-through;
  color: #888;
}

/* ===== æœ¬æ–‡ ===== */
#main {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
}

.main-title {
  font-size: 1.4em;
  margin-top: 24px;
}

.sub-box {
  border: 1px solid #ddd;
  padding: 10px;
  margin-top: 10px;
}

.sub-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.sub-header span {
  font-weight: bold;
}

textarea {
  width: 100%;
  min-height: 90px;
  margin-top: 6px;
  box-sizing: border-box;
  font-size: 1em;
}

button {
  cursor: pointer;
  font-size: 0.85em;
}
</style>
</head>

<body>

<div id="toc">
  <h2>ç›®æ¬¡</h2>
  <hr>
<button onclick="exportJSON()">ğŸ“¤ JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button><br>
<button onclick="importJSON()">ğŸ“¥ JSONèª­ã¿è¾¼ã¿</button>
<input type="file" id="jsonInput" accept=".json" style="display:none">
  <button onclick="addMain()">ï¼‹ å¤§é …ç›®</button>
  <div id="tocList"></div>
</div>

<div id="main"></div>

<script>
const STORAGE_KEY = "kokushi-my-study";
let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  render();
}

function addMain() {
  const title = prompt("å¤§é …ç›®åã‚’å…¥åŠ›");
  if (!title) return;
  data.push({ title, subs: [] });
  save();
}

function addSub(mainIndex) {
  const title = prompt("å°é …ç›®åã‚’å…¥åŠ›");
  if (!title) return;
  data[mainIndex].subs.push({
    title,
    text: "",
    checked: false
  });
  save();
}

function toggleCheck(mi, si) {
  const sub = data[mi].subs[si];
  sub.checked = !sub.checked;
  save();
}

function updateText(mi, si, value) {
  data[mi].subs[si].text = value;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function render() {
  const toc = document.getElementById("tocList");
  const main = document.getElementById("main");
  toc.innerHTML = "";
  main.innerHTML = "";

  data.forEach((m, mi) => {
    /* ---- ç›®æ¬¡ï¼šå¤§é …ç›® ---- */
    const tocMain = document.createElement("div");
    tocMain.className = "toc-main";
    tocMain.textContent = m.title;
    toc.appendChild(tocMain);

    /* ---- æœ¬æ–‡ï¼šå¤§é …ç›® ---- */
    const mainTitle = document.createElement("div");
    mainTitle.className = "main-title";
    mainTitle.textContent = m.title;
    main.appendChild(mainTitle);

    const addSubBtn = document.createElement("button");
    addSubBtn.textContent = "ï¼‹ å°é …ç›®";
    addSubBtn.onclick = () => addSub(mi);
    main.appendChild(addSubBtn);

    m.subs.forEach((s, si) => {
      /* ç›®æ¬¡ï¼šå°é …ç›® */
      const tocSub = document.createElement("div");
      tocSub.className = "toc-sub" + (s.checked ? " checked" : "");
      tocSub.textContent = "ãƒ»" + s.title;
      tocSub.onclick = () => toggleCheck(mi, si);
      toc.appendChild(tocSub);

      /* æœ¬æ–‡ï¼šå°é …ç›® */
      const box = document.createElement("div");
      box.className = "sub-box";

      const header = document.createElement("div");
      header.className = "sub-header";

      const titleSpan = document.createElement("span");
      titleSpan.textContent = s.title;

      const checkBtn = document.createElement("button");
      checkBtn.textContent = s.checked ? "âœ”ï¸ è§£é™¤" : "âœ”ï¸ å®Œäº†";
      checkBtn.onclick = () => toggleCheck(mi, si);

      header.appendChild(titleSpan);
      header.appendChild(checkBtn);

      const textarea = document.createElement("textarea");
      textarea.value = s.text;
      textarea.oninput = e => updateText(mi, si, e.target.value);

      box.appendChild(header);
      box.appendChild(textarea);
      main.appendChild(box);
    });
  });
}

render();

function exportJSON() {
  const blob = new Blob(
    [JSON.stringify(data, null, 2)],
    { type: "application/json" }
  );

  const date = new Date().toISOString().slice(0,10);
  const filename = `kokushi-backup-${date}.json`;

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function importJSON() {
  document.getElementById("jsonInput").click();
}

document.getElementById("jsonInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try {
      data = JSON.parse(reader.result);
      save();
      alert("èª­ã¿è¾¼ã¿å®Œäº†ï¼");
    } catch {
      alert("JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
    }
  };
  reader.readAsText(file);
});
</script>

</body>
</html>