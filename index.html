<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å›½è©¦ãƒã‚¤ã‚¹ã‚¿ãƒ‡ã‚£!</title>

<style>

.toolbar-global {
  position: sticky;
  top: 0;
  background: #fff;
  border-bottom: 1px solid #ccc;
  padding: 8px;
  z-index: 1000;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  display: flex;
  height: 100vh;
  overflow: hidden; /* â† bodyã¯çµ¶å¯¾ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ */
}

/* ===== ç›®æ¬¡ ===== */
#toc {
  width: 280px;
  border-right: 1px solid #ccc;
  padding: 10px;
  background: #f7f7f7;
  overflow-y: auto;   /* å·¦ã¯å·¦ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
}

#content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden; /* â† ä¸­ã§åˆ†æ¥­ */
}

#toc h2 { margin-top: 0; }

.toc-main {
  font-weight: bold;
  margin-top: 14px;
}

.toc-sub {
  margin-left: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
}

.toc-sub span {
  margin-right: 6px;
  font-size: 1.3em;
}



/* ===== æœ¬æ–‡ ===== */



#main {
  flex: 1;
  padding: 16px;
  overflow-y: auto;  /* â† å³å´ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ã“ã“ã ã‘ */
}

.main-title {
  font-size: 1.5em;
  margin-top: 28px;
}

.sub-box {
  border: 1px solid #ddd;
  padding: 10px;
  margin-top: 12px;
}

.sub-header {
  display: flex;
  justify-content: space-between;
  cursor: pointer;
  font-weight: bold;
}

.editor {
  margin-top: 10px;
  border: 1px solid #ccc;
  padding: 8px;
  min-height: 120px;
  line-height: 1.6;
  max-height: none;
  overflow: visible;
  overscroll-behavior: contain;
}

.editor:focus {
  outline: 2px solid #4caf50;
}

.toolbar button {
  font-size: 0.85em;
  margin-right: 6px;
}

table {
  border-collapse: collapse;
  margin: 8px 0;
}
td, th {
  border: 1px solid #666;
  padding: 6px;
  min-width: 60px;
}

#searchBox {
  width: 100%;
  padding: 6px;
  margin-bottom: 6px;
}

/* ===== è¡¨ç·¨é›† ===== */
.table-toolbar {
  position: fixed;
  background: #333;
  color: #fff;
  padding: 6px;
  border-radius: 6px;
  font-size: 12px;
  display: none;
  z-index: 9999;
}

.table-toolbar button {
  margin: 2px;
  font-size: 12px;
}

/* åˆ—å¹…ãƒ‰ãƒ©ãƒƒã‚° */
table {
  table-layout: fixed;
}

td, th {
  resize: horizontal;
  overflow: auto;
}

html, body {
  height: 100%;
  overflow-y: auto;
}

.sub-header button,
.main-title button {
  background: none;
  border: none;
  cursor: pointer;
  opacity: 0.6;
}

.sub-header button:hover,
.main-title button:hover {
  opacity: 1;
}

</style>
</head>

<body>



<div id="toc">
  <button onclick="undo()">â†©</button>
<button onclick="redo()">â†ª</button>
  <h2>ç›®æ¬¡</h2>
  <input id="searchBox" placeholder="ğŸ” æ¤œç´¢" oninput="render()">



  <button onclick="exportJSON()">ğŸ“¤ JSON</button>
  <button onclick="importJSON()">ğŸ“¥ èª­è¾¼</button>
  <input type="file" id="jsonInput" accept=".json" hidden>

  <hr>
  <button onclick="addMain()">ï¼‹ å¤§é …ç›®</button>
  <div id="tocList"></div>
</div>

<div id="content">
<div id="editorToolbar" class="toolbar-global">
  <button onclick="cmd('bold')">å¤ªå­—</button>
  <button onclick="cmd('underline')">ä¸‹ç·š</button>
  <button onclick="insertTable()">è¡¨</button>
</div>

<div id="main"></div>
</div>

<div id="tableToolbar" class="table-toolbar">
  <button onclick="moveRow(-1)">â¬† è¡Œ</button>
  <button onclick="moveRow(1)">â¬‡ è¡Œ</button>
  <button onclick="moveCol(-1)">â¬… åˆ—</button>
  <button onclick="moveCol(1)">â¡ åˆ—</button>
  <hr>
  <button onclick="addRow()">è¡Œï¼‹</button>
  <button onclick="addCol()">åˆ—ï¼‹</button>
  <button onclick="delRow()">è¡Œâˆ’</button>
  <button onclick="delCol()">åˆ—âˆ’</button>
</div>

<script>
/* =====================
   åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ç®¡ç†
===================== */
const KEY = "kokushi-my-study";
let data = JSON.parse(localStorage.getItem(KEY)) || [];

/* =====================
   undo / redo ç”¨å±¥æ­´
===================== */
let history = [];
let historyIndex = -1;

function snapshot() {
  history = history.slice(0, historyIndex + 1);
  history.push(JSON.stringify(data));
  historyIndex++;
}

function save() {
  snapshot();
  localStorage.setItem(KEY, JSON.stringify(data));
}

function saveRaw() {
  localStorage.setItem(KEY, JSON.stringify(data));
  render();
}

/* åˆæœŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ */
snapshot();

/* =====================
   å¤§é …ç›®ãƒ»å°é …ç›®
===================== */
function addMain() {
  const t = prompt("å¤§é …ç›®å");
  if (!t) return;
  data.push({ title: t, subs: [] });
  save(); render();
}

function addSub(mi) {
  const t = prompt("å°é …ç›®å");
  if (!t) return;
  data[mi].subs.push({ title: t, html: "", checked: false, open: true });
  save(); render();
}

/* =====================
   å‰Šé™¤
===================== */
function deleteMain(mi) {
  if (!confirm(`ã€Œ${data[mi].title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆä¸­ã®å°é …ç›®ã‚‚å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`)) return;
  data.splice(mi, 1);
  save(); render();
}

function deleteSub(mi, si) {
  if (!confirm(`ã€Œ${data[mi].subs[si].title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  data[mi].subs.splice(si, 1);
  save(); render();
}

/* =====================
   æç”»
===================== */
function render() {
  const toc = document.getElementById("tocList");
  const main = document.getElementById("main");
  const kw = document.getElementById("searchBox").value.toLowerCase();
  toc.innerHTML = main.innerHTML = "";

  data.forEach((m, mi) => {
    let hitMain = false;
    const subsDom = [];

    m.subs.forEach((s, si) => {
      if (kw && !(s.title + s.html).toLowerCase().includes(kw)) return;
      hitMain = true;
      const id = `sub-${mi}-${si}`;

      const tocSub = document.createElement("div");
      tocSub.className = "toc-sub";
      tocSub.innerHTML = `<span>${s.checked ? "â˜‘" : "â˜"}</span>${s.title}`;
      tocSub.onclick = e => {
  if (e.altKey) {
    const t = prompt("å°é …ç›®åã‚’å¤‰æ›´", s.title);
    if (!t) return;
    s.title = t;
    save(); render();
  } else {
    document.getElementById(id).scrollIntoView();
  }
};
      

      const box = document.createElement("div");
      box.className = "sub-box";
      box.id = id;

      const header = document.createElement("div");
header.className = "sub-header";

const title = document.createElement("span");
title.textContent = s.title;

const del = document.createElement("button");
del.textContent = "ğŸ—‘";
del.style.fontSize = "0.9em";
del.onclick = e => {
  e.stopPropagation(); // â† é–‹é–‰ã‚¯ãƒªãƒƒã‚¯ã‚’é˜²ã
  deleteSub(mi, si);
};

header.append(title, del);

header.onclick = e => {
  if (e.altKey) {
    const t = prompt("å°é …ç›®åã‚’å¤‰æ›´", s.title);
    if (!t) return;
    s.title = t;
    save(); render();
  } else {
    s.open = !s.open;
    save(); render();
  }
};

      

      const editor = document.createElement("div");
      editor.className = "editor";
      editor.contentEditable = true;
      editor.innerHTML = s.html;
      editor.oninput = () => {
        s.html = editor.innerHTML;
        save();
      };
      editor.onfocus = () => {
  activeEditor = editor;
};

      if (!s.open) editor.style.display = "none";

      box.append(header, editor);
      subsDom.push(box);
    });

        // ç›®æ¬¡ã¨æœ¬æ–‡ã®ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºï¼ˆæ¤œç´¢æ¡ä»¶ã«åˆã†å ´åˆã®ã¿ï¼‰
    if (hitMain || !kw) {
                  // --- é•·æŠ¼ã—åˆ¤å®šç”¨ã®å…±é€šé–¢æ•° ---
      const addLongPress = (el, onLongPress, onClick) => {
        let timer;
        let isLong = false;
        el.onmousedown = el.ontouchstart = (e) => {
          isLong = false;
          timer = setTimeout(() => { isLong = true; onLongPress(); }, 500); 
        };
        el.onmouseup = el.onmouseleave = el.ontouchend = () => clearTimeout(timer);
        el.onclick = (e) => { if (!isLong && onClick) onClick(e); };
      };

      // --- å·¦å´ã®ç›®æ¬¡ï¼ˆå¤§é …ç›®ï¼‰ã‚’è¿½åŠ  ---
      const tmToc = document.createElement("div");
      tmToc.className = "toc-main";
      tmToc.style.cursor = "pointer";
      tmToc.textContent = m.title;

      // å¤§é …ç›®ã®å‹•ä½œï¼šçŸ­æŠ¼ã—ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã€é•·æŠ¼ã—ã§åå‰å¤‰æ›´
      addLongPress(tmToc,
        () => { const t = prompt("å¤§é …ç›®åã‚’å¤‰æ›´", m.title); if (t) { m.title = t; save(); render(); } },
        () => {
          // æœ¬æ–‡ã®å¤§é …ç›®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆmain-titleï¼‰ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          const target = Array.from(main.querySelectorAll('.main-title')).find(el => el.textContent.includes(m.title));
          if (target) target.scrollIntoView({ behavior: 'smooth' });
        }
      );
      toc.appendChild(tmToc);

      // --- å·¦å´ã®ç›®æ¬¡ï¼ˆå°é …ç›®ï¼‰ã‚’è¿½åŠ  ---
      m.subs.forEach((s, si) => {
        if (kw && !(s.title + s.html).toLowerCase().includes(kw)) return;
        const id = `sub-${mi}-${si}`;
        const tocSub = document.createElement("div");
        tocSub.className = "toc-sub";

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å¤§ããã—ã¦æŠ¼ã—ã‚„ã™ã
        const checkSpan = document.createElement("span");
        checkSpan.textContent = s.checked ? "â˜‘" : "â˜";
        checkSpan.style.color = s.checked ? "#4caf50" : "#999";
        checkSpan.style.fontSize = "1.5em"; // ã‚µã‚¤ã‚ºã‚’å¤§ãã
        checkSpan.style.marginRight = "10px";
        checkSpan.style.padding = "4px 8px"; // ã‚¯ãƒªãƒƒã‚¯ç¯„å›²ã‚’åºƒã’ã‚‹
        checkSpan.style.display = "inline-block";

        const titleSpan = document.createElement("span");
        titleSpan.textContent = s.title;
        titleSpan.style.color = s.checked ? "#888" : "inherit";

        tocSub.append(checkSpan, titleSpan);
        
        addLongPress(tocSub,
          () => { const t = prompt("å°é …ç›®åã‚’å¤‰æ›´", s.title); if (t) { s.title = t; save(); render(); } },
          (e) => {
            if (e.target === checkSpan) {
              s.checked = !s.checked;
              save(); render();
            } else {
              const target = document.getElementById(id);
              if (target) target.scrollIntoView({ behavior: 'smooth' });
            }
          }
        );
        toc.appendChild(tocSub);
      });



      // --- å³å´ã®æœ¬æ–‡ã‚¨ãƒªã‚¢ã®æç”»é–‹å§‹ ---


      const mt = document.createElement("div");
mt.className = "main-title";

const title = document.createElement("span");
title.textContent = m.title;

const del = document.createElement("button");
del.textContent = "ğŸ—‘";
del.style.marginLeft = "8px";
del.onclick = () => deleteMain(mi);

mt.append(title, del);

mt.onclick = () => {
  const t = prompt("å¤§é …ç›®åã‚’å¤‰æ›´", m.title);
  if (!t) return;
  m.title = t;
  save(); render();
};

main.append(mt);

      const btn = document.createElement("button");
      btn.textContent = "ï¼‹ å°é …ç›®";
      btn.onclick = () => addSub(mi);
      main.append(btn);

      subsDom.forEach(d => main.append(d));
    }
  });
}

/* =====================
   ã‚¨ãƒ‡ã‚£ã‚¿æ“ä½œ
===================== */
 function cmd(c) {
  if (!activeEditor) return;
  activeEditor.focus();
  document.execCommand(c);
}

function insertTable() {
  if (!activeEditor) return;
  activeEditor.focus();

  const html = `
    <table>
      <tr><td contenteditable="true"></td><td contenteditable="true"></td></tr>
      <tr><td contenteditable="true"></td><td contenteditable="true"></td></tr>
    </table>`;
  document.execCommand("insertHTML", false, html);
}

/* =====================
   JSONå…¥å‡ºåŠ›
===================== */
function exportJSON() {
  const b = new Blob([JSON.stringify(data, null, 2)]);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(b);
  a.download = "kokushi-backup.json";
  a.click();
}

function importJSON() {
  jsonInput.click();
}

jsonInput.onchange = e => {
  const r = new FileReader();
  r.onload = () => {
    data = JSON.parse(r.result);
    snapshot();
    saveRaw();
  };
  r.readAsText(e.target.files[0]);
};

/* =====================
   è¡¨æ“ä½œï¼ˆé¸æŠç®¡ç†ï¼‰
===================== */
let activeTable = null;
let activeCell = null;
let activeEditor = null;

document.addEventListener("click", e => {
  const toolbar = document.getElementById("tableToolbar");
  const cell = e.target.closest("td, th");

  if (cell) {
    activeCell = cell;
    activeTable = cell.closest("table");

    toolbar.style.display = "block";
    toolbar.style.top = e.clientY + 10 + "px";
    toolbar.style.left = e.clientX + 10 + "px";
  } else {
    toolbar.style.display = "none";
    activeCell = activeTable = null;
  }
});

/* =====================
   è¡Œãƒ»åˆ— è¿½åŠ å‰Šé™¤
===================== */
function addRow() {
  if (!activeTable) return;
  const row = activeTable.insertRow();
  const cols = activeTable.rows[0].cells.length;
  for (let i = 0; i < cols; i++) row.insertCell().contentEditable = "true";
  save();
}

function addCol() {
  if (!activeTable) return;
  for (const r of activeTable.rows) r.insertCell().contentEditable = "true";
  save();
}

function delRow() {
  if (!activeTable || activeTable.rows.length <= 1) return;
  activeTable.deleteRow(-1);
  save();
}

function delCol() {
  if (!activeTable) return;
  const cols = activeTable.rows[0].cells.length;
  if (cols <= 1) return;
  for (const r of activeTable.rows) r.deleteCell(-1);
  save();
}

/* =====================
   è¡Œãƒ»åˆ— ç§»å‹•ï¼ˆâ‘¡â‘¢â‘¤â‘¥ï¼‰
===================== */
function moveRow(dir) {
  if (!activeCell || !activeTable) return;

  const row = activeCell.parentElement;
  const rows = Array.from(activeTable.rows);
  const index = rows.indexOf(row);

  // ä¸Šé™ãƒ»ä¸‹é™ãƒã‚§ãƒƒã‚¯
  if (dir === -1 && index === 0) return;
  if (dir === 1 && index === rows.length - 1) return;

  const targetIndex = index + dir;
  const reference =
    dir === -1
      ? rows[targetIndex]                  // ä¸Šã¸ â†’ å¯¾è±¡è¡Œã®å‰
      : rows[targetIndex].nextSibling;     // ä¸‹ã¸ â†’ å¯¾è±¡è¡Œã®ã€Œæ¬¡ã€

  activeTable.insertBefore(row, reference);
  save();
}

function moveCol(dir) {
  if (!activeCell) return;
  const row = activeCell.parentElement;
  const c = Array.from(row.cells).indexOf(activeCell);
  const t = c + dir;
  if (t < 0 || t >= row.cells.length) return;

  for (const r of activeTable.rows) {
    const cell = r.cells[c];
    const ref = r.cells[t];
    dir === -1
      ? r.insertBefore(cell, ref)
      : r.insertBefore(ref, cell);
  }
  save();
}

/* =====================
   undo / redoï¼ˆâ‘¦-â‘¤é™¤å¤–ï¼‰
===================== */
function undo() {
  if (historyIndex <= 0) return;
  historyIndex--;
  data = JSON.parse(history[historyIndex]);
  saveRaw();
}

function redo() {
  if (historyIndex >= history.length - 1) return;
  historyIndex++;
  data = JSON.parse(history[historyIndex]);
  saveRaw();
}

document.addEventListener("keydown", e => {
  if (e.key !== "Enter") return;

  const sel = window.getSelection();
  if (!sel.rangeCount) return;

  let node = sel.anchorNode;
  if (node.nodeType === 3) node = node.parentElement;

  const cell = node.closest("td, th");
  if (!cell) return;   // â† è¡¨å¤–ãªã‚‰å®Œå…¨ã‚¹ãƒ«ãƒ¼

  e.preventDefault();

// Shift + Enter â†’ ã‚»ãƒ«å†…æ”¹è¡Œï¼ˆç¢ºå®Ÿç‰ˆï¼‰
if (e.shiftKey) {
  const br = document.createElement("br");
  const range = sel.getRangeAt(0);

  range.deleteContents();
  range.insertNode(br);

  // ã‚­ãƒ£ãƒ¬ãƒƒãƒˆã‚’ <br> ã®å¾Œã‚ã¸
  range.setStartAfter(br);
  range.collapse(true);
  sel.removeAllRanges();
  sel.addRange(range);

  save();
  return;
}

  const row = cell.parentElement;
  const table = row.closest("table");
  const rows = Array.from(table.rows);
  const rowIndex = rows.indexOf(row);
  const colIndex = Array.from(row.cells).indexOf(cell);

  // æœ€ä¸‹è¡Œãªã‚‰æ–°è¦è¡Œè¿½åŠ 
  let targetRow;
  if (rowIndex === rows.length - 1) {
    targetRow = table.insertRow();
    for (let i = 0; i < row.cells.length; i++) {
      const c = targetRow.insertCell();
      c.contentEditable = "true";
      c.tabIndex = -1;
      c.innerHTML = "";
    }
  } else {
    targetRow = rows[rowIndex + 1];
  }

  const targetCell = targetRow.cells[colIndex];
  targetCell.tabIndex = -1;
  targetCell.focus();

  // ã‚­ãƒ£ãƒ¬ãƒƒãƒˆã‚’å…ˆé ­ã¸
  const range = document.createRange();
  range.selectNodeContents(targetCell);
  range.collapse(true);
  sel.removeAllRanges();
  sel.addRange(range);

  save();
});

/* =====================
   åˆæœŸæç”»
===================== */
render();
</script>
</body>
</html>