<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>SPEED - Table Battle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <style>
    :root {
      --bg-color: #1a472a;
      --card-white: #ffffff;
      --card-text: #333;
      --p1-color: #2196f3;
      --p2-color: #f44336;
      --accent-color: #ffd700;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans JP', sans-serif;
      background-color: var(--bg-color);
      color: white;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      touch-action: none;
    }

    #board {
      width: 100%;
      max-width: 600px;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px;
      box-sizing: border-box;
    }

    .opponent-side {
      transform: rotate(180deg);
    }

    .area-label {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
      opacity: 0.8;
    }

    .hand {
      display: flex;
      justify-content: center;
      gap: 10px;
      min-height: 100px;
    }

    .field-area {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 20px 0;
    }

    .card {
      width: 65px;
      height: 90px;
      background: var(--card-white);
      border-radius: 8px;
      color: var(--card-text);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: transform 0.1s;
      user-select: none;
    }

    .card:active {
      transform: scale(1.05);
    }

    .field-card {
      border: 3px solid var(--accent-color);
      background: #f0f0f0;
    }

    .pop {
      animation: popAnim 0.2s ease-out;
    }
    @keyframes popAnim {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    #control-panel {
      position: absolute;
      background: rgba(0,0,0,0.85);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 100;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    button {
      padding: 10px 20px;
      font-size: 18px;
      font-weight: bold;
      background: var(--accent-color);
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .deck-info {
      font-size: 12px;
      margin-top: 5px;
      opacity: 0.7;
    }
  </style>
</head>
<body>

<div id="control-panel">
  <p id="msg">すぴーどーーー</p>
  <button onclick="startGame()">ゲームスタート</button>
</div>

<div id="board">
  <div class="opponent-side">
    <div class="hand" id="p2-hand"></div>
    <div class="field-area">
      <div id="p2-field-left" class="card field-card">?</div>
      <div id="p2-field-right" class="card field-card">?</div>
    </div>
    <div class="area-label">PLAYER 2 <span id="p2-deck-count" class="deck-info"></span></div>
  </div>

  <hr style="width: 100%; opacity: 0.2;">

  <div class="player-side">
    <div class="area-label">PLAYER 1 <span id="p1-deck-count" class="deck-info"></span></div>
    <div class="field-area">
      <div id="p1-field-left" class="card field-card">?</div>
      <div id="p1-field-right" class="card field-card">?</div>
    </div>
    <div class="hand" id="p1-hand"></div>
  </div>
</div>

<script>
  let p1Hand = [];
  let p2Hand = [];
  let p1Deck = [];
  let p2Deck = [];
  let field = { left: null, right: null };
  const suits = ['♠', '♥', '♦', '♣'];
  let isProcessingStuck = false;

  function startGame() {
    document.getElementById('control-panel').style.display = 'none';
    isProcessingStuck = false;
    
    [span_0](start_span)// 52枚のカードを作成[span_0](end_span)
    let allCards = [];
    for (let s of suits) {
      for (let n = 1; n <= 13; n++) {
        [span_1](start_span)allCards.push({ num: n, suit: s });[span_1](end_span)
      }
    }

    [span_2](start_span)// シャッフル[span_2](end_span)
    allCards.sort(() => Math.random() - 0.5);

    [span_3](start_span)// 26枚ずつ分ける[span_3](end_span)
    p1Deck = allCards.slice(0, 26);
    p2Deck = allCards.slice(26, 52);

    [span_4](start_span)// 手札4枚ずつ配る[span_4](end_span)
    p1Hand = p1Deck.splice(0, 4);
    p2Hand = p2Deck.splice(0, 4);

    [span_5](start_span)// 場の初期カード[span_5](end_span)
    field.left = p1Deck.shift();
    field.right = p2Deck.shift();

    updateUI();
  }

  function updateUI() {
    [span_6](start_span)// フィールド表示の更新[span_6](end_span)
    const fLeftStr = `${field.left.suit}${field.left.num}`;
    const fRightStr = `${field.right.suit}${field.right.num}`;
    
    document.getElementById('p1-field-left').textContent = fLeftStr;
    document.getElementById('p2-field-left').textContent = fLeftStr;
    document.getElementById('p1-field-right').textContent = fRightStr;
    document.getElementById('p2-field-right').textContent = fRightStr;

    // マークの色付け
    setColor(document.getElementById('p1-field-left'), field.left.suit);
    setColor(document.getElementById('p2-field-left'), field.left.suit);
    setColor(document.getElementById('p1-field-right'), field.right.suit);
    setColor(document.getElementById('p2-field-right'), field.right.suit);

    renderHand('p1-hand', p1Hand, 1);
    renderHand('p2-hand', p2Hand, 2);

    // 山札残り枚数の表示
    document.getElementById('p1-deck-count').textContent = `(残り:${p1Deck.length})`;
    document.getElementById('p2-deck-count').textContent = `(残り:${p2Deck.length})`;
    
    [span_7](start_span)// 勝利判定[span_7](end_span)
    if (p1Hand.length === 0 && p1Deck.length === 0) {
      alert("PLAYER 1 WIN!");
      location.reload();
      return;
    }
    if (p2Hand.length === 0 && p2Deck.length === 0) {
      alert("PLAYER 2 WIN!");
      location.reload();
      return;
    }

    // 手詰まりチェックを予約
    setTimeout(checkStuck, 800);
  }

  function setColor(el, suit) {
    el.style.color = (suit === '♥' || suit === '♦') ? 'red' : '#333';
  }

  function renderHand(elementId, hand, playerNum) {
    const el = document.getElementById(elementId);
    el.innerHTML = '';
    hand.forEach((cardObj, i) => {
      const cardEl = document.createElement('div');
      cardEl.className = 'card';
      setColor(cardEl, cardObj.suit);
      cardEl.textContent = `${cardObj.suit}${cardObj.num}`;
      cardEl.onclick = () => tryPlay(playerNum, i);
      el.appendChild(cardEl);
    });
  }

  function tryPlay(playerNum, cardIndex) {
    if (isProcessingStuck) return;

    const hand = (playerNum === 1) ? p1Hand : p2Hand;
    const deck = (playerNum === 1) ? p1Deck : p2Deck;
    const card = hand[cardIndex];

    [span_8](start_span)// 出せるか判定[span_8](end_span)
    if (isPlayable(card.num, field.left.num)) {
      field.left = card;
      animateField('left');
    } else if (isPlayable(card.num, field.right.num)) {
      field.right = card;
      animateField('right');
    } else {
      return;
    }

    // 出した場所に補充するロジック
    if (deck.length > 0) {
      hand.splice(cardIndex, 1, deck.shift());
    } else {
      hand.splice(cardIndex, 1);
    }
    
    updateUI();
  }

  function isPlayable(card, target) {
    const diff = Math.abs(card - target);
    return diff === 1 || diff === 12; [span_9](start_span)// 1と13も繋がる[span_9](end_span)
  }

  function checkStuck() {
    if (isProcessingStuck) return;
    
    const allHands = [...p1Hand, ...p2Hand];
    const canPlay = allHands.some(c => 
      isPlayable(c.num, field.left.num) || isPlayable(c.num, field.right.num)
    );
    
    if (!canPlay && (p1Hand.length > 0 || p2Hand.length > 0)) {
      startStuckRecovery();
    }
  }

  async function startStuckRecovery() {
    isProcessingStuck = true;
    const msgEl = document.getElementById('control-panel');
    const textEl = document.getElementById('msg');
    msgEl.style.display = 'block';
    
    for (let i = 3; i > 0; i--) {
      [span_10](start_span)textEl.textContent = `出せる札がありません！ ${i}`;[span_10](end_span)
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    [span_11](start_span)textEl.textContent = "ゴー！";[span_11](end_span)

    // 山札から優先、なければ手札から場に出す
    if (p1Deck.length > 0) field.left = p1Deck.shift();
    else if (p1Hand.length > 0) field.left = p1Hand.shift();
    
    if (p2Deck.length > 0) field.right = p2Deck.shift();
    else if (p2Hand.length > 0) field.right = p2Hand.shift();

    setTimeout(() => {
      msgEl.style.display = 'none';
      isProcessingStuck = false;
      updateUI();
    }, 800);
  }

  function animateField(side) {
    const ids = [`p1-field-${side}`, `p2-field-${side}`];
    ids.forEach(id => {
      const el = document.getElementById(id);
      el.classList.add('pop');
      [span_12](start_span)setTimeout(() => el.classList.remove('pop'), 200);[span_12](end_span)
    });
  }
</script>
</body>
</html>
