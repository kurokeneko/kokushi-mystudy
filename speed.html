<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>SPEED - Table Battle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <style>
    :root {
      --bg-color: #1a472a;
      --card-white: #ffffff;
      --card-text: #333;
      --p1-color: #2196f3;
      --p2-color: #f44336;
      --accent-color: #ffd700;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans JP', sans-serif;
      background-color: var(--bg-color);
      color: white;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      touch-action: none; /* 誤操作防止 */
    }

    #board {
      width: 100%;
      max-width: 600px;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px;
      box-sizing: border-box;
    }

    /* 相手側（上）を180度回転 */
    .opponent-side {
      transform: rotate(180deg);
    }

    .area-label {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
      opacity: 0.8;
    }

    .hand {
      display: flex;
      justify-content: center;
      gap: 10px;
      min-height: 100px;
    }

    .field-area {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 20px 0;
    }

    .card {
      width: 65px;
      height: 90px;
      background: var(--card-white);
      border-radius: 8px;
      color: var(--card-text);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: transform 0.1s;
    }

        /* 選択中のカードのスタイル */
    .selected {
      transform: translateY(-15px) scale(1.1);
      box-shadow: 0 0 15px var(--accent-color);
      border: 2px solid var(--accent-color);
      z-index: 10;
    }

    .card:active {
      transform: scale(1.1);
    }


    /* 場のカード（共通） */
    .field-card {
      border: 3px solid var(--accent-color);
      background: #f0f0f0;
    }

    .pop {
      animation: popAnim 0.2s ease-out;
    }
    @keyframes popAnim {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    #control-panel {
      position: absolute;
      background: rgba(0,0,0,0.7);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      z-index: 100;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      font-weight: bold;
      background: var(--accent-color);
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="control-panel">
  <p id="msg">タブレットを真ん中に置いて対戦！</p>
  <button onclick="startGame()">ゲームスタート</button>
</div>

<div id="board">
  <div class="opponent-side">
    <div class="hand" id="p2-hand"></div>
       <div class="field-area">
      <div id="p2-field-left" class="card field-card" onclick="tryPlay(2, 'left')">?</div>
      <div id="p2-field-right" class="card field-card" onclick="tryPlay(2, 'right')">?</div>
    </div>

    <div class="area-label">PLAYER 2</div>
  </div>

  <hr style="width: 100%; opacity: 0.2;">

  <div class="player-side">
    <div class="area-label">PLAYER 1</div>
      <div class="field-area">
      <div id="p1-field-left" class="card field-card" onclick="tryPlay(1, 'left')">?</div>
      <div id="p1-field-right" class="card field-card" onclick="tryPlay(1, 'right')">?</div>
    </div>

    <div class="hand" id="p1-hand"></div>
  </div>
</div>

<script>
  let p1Hand = [];
  let p2Hand = [];
  let p1Deck = [];
  let p2Deck = [];
  let field = { left: null, right: null };
  [span_0](start_span)[span_1](start_span)// 選択状態を管理する変数[span_0](end_span)[span_1](end_span)
  let p1SelectedIndex = null;
  let p2SelectedIndex = null;

  const suits = ['♠', '♥', '♦', '♣'];

  function startGame() {
    document.getElementById('control-panel').style.display = 'none';
    
    // 52枚のカードを作成
    let allCards = [];
    for (let s of suits) {
      for (let n = 1; n <= 13; n++) {
        allCards.push({ num: n, suit: s });
      }
    }

    // シャッフル
    allCards.sort(() => Math.random() - 0.5);

    // 半分ずつ分ける (26枚ずつ)
    p1Deck = allCards.slice(0, 26);
    p2Deck = allCards.slice(26, 52);

    // 初期の手札 (4枚ずつ)
    p1Hand = p1Deck.splice(0, 4);
    p2Hand = p2Deck.splice(0, 4);

    // フィールドの初期値
    field.left = p1Deck.shift();
    field.right = p2Dshift();
    
      function tryPlay(playerNum, side) {
    const selectedIdx = (playerNum === 1) ? p1SelectedIndex : p2SelectedIndex;
    if (selectedIdx === null) return; 

    const hand = (playerNum === 1) ? p1Hand : p2Hand;
    const deck = (playerNum === 1) ? p1Deck : p2Deck;
    const card = hand[selectedIdx];
    const targetCard = field[side];

    if (isPlayable(card.num, targetCard.num)) {
      field[side] = card;
      animateField(side);
      
      if (deck.length > 0) {
        hand[selectedIdx] = deck.shift();
      } else {
        hand[selectedIdx] = null;
      }
      
      if (playerNum === 1) p1SelectedIndex = null;
      else p2SelectedIndex = null;
  
      
      // カードを出した直後に手詰まりチェックを実行
      setTimeout(checkStuck, 500);
    }
  }



    function updateUI() {
    // フィールド更新
    const fLeft = `${field.left.suit}${field.left.num}`;
    const fRight = `${field.right.suit}${field.right.num}`;
    
    document.getElementById('p1-field-left').textContent = fLeft;
    document.getElementById('p2-field-left').textContent = fLeft;
    document.getElementById('p1-field-right').textContent = fRight;
    document.getElementById('p2-field-right').textContent = fRight;

    renderHand('p1-hand', p1Hand, 1);
    renderHand('p2-hand', p2Hand, 2);
    
    // 勝利判定
    // null（空き）を除いた手札の枚数で勝利判定
    const p1Remaining = p1Hand.filter(c => c !== null).length;
    const p2Remaining = p2Hand.filter(c => c !== null).length;
    // フィールド更新
    const fLeft = `${field.left.suit}${field.left.num}`;
    const fRight = `${field.right.suit}${field.right.num}`;
    
    document.getElementById('p1-field-left').textContent = fLeft;
    document.getElementById('p2-field-left').textContent = fLeft;
    document.getElementById('p1-field-right').textContent = fRight;
    document.getElementById('p2-field-right').textContent = fRight;

    renderHand('p1-hand', p1Hand, 1);
    renderHand('p2-hand', p2Hand, 2);

    if (p1Remaining === 0 && p1Deck.length === 0) alert("Player 1 WIN!");
    if (p2Remaining === 0 && p2Deck.length === 0) alert("Player 2 WIN!");

  }

     function renderHand(elementId, hand, playerNum) {
    const el = document.getElementById(elementId);
    el.innerHTML = '';
    [span_2](start_span)const selectedIdx = (playerNum === 1) ? p1SelectedIndex : p2SelectedIndex;[span_2](end_span)

    hand.forEach((cardObj, i) => {
      const cardEl = document.createElement('div');
      cardEl.className = 'card';
      
      if (cardObj) {
        if (cardObj.suit === '♥' || cardObj.suit === '♦') cardEl.style.color = 'red';
        cardEl.textContent = `${cardObj.suit}${cardObj.num}`;
        
        [span_3](start_span)// 選択中ならクラスを付与[span_3](end_span)
        if (i === selectedIdx) cardEl.classList.add('selected');
        
        // クリックで「選択」する
        cardEl.onclick = () => selectCard(playerNum, i);
      } else {
        cardEl.style.visibility = 'hidden'; 
      }
      el.appendChild(cardEl);
    });
  }

  // 札を選択する関数
  function selectCard(playerNum, index) {
    if (playerNum === 1) p1SelectedIndex = (p1SelectedIndex === index) ? null : index;
    else p2SelectedIndex = (p2SelectedIndex === index) ? null : index;
    updateUI();
  }




      function tryPlay(playerNum, side) {
    const selectedIdx = (playerNum === 1) ? p1SelectedIndex : p2SelectedIndex;
    if (selectedIdx === null) return; [span_4](start_span)// 札が選ばれてなければ何もしない[span_4](end_span)

    const hand = (playerNum === 1) ? p1Hand : p2Hand;
    const deck = (playerNum === 1) ? p1Deck : p2Deck;
    const card = hand[selectedIdx];
    const targetCard = field[side];

    [span_5](start_span)if (isPlayable(card.num, targetCard.num)) {[span_5](end_span)
      field[side] = card;
      animateField(side);
      
      // 補充
      if (deck.length > 0) {
        hand[selectedIdx] = deck.shift();
      } else {
        hand[selectedIdx] = null;
      }
      
      // 選択状態をリセット
      if (playerNum === 1) p1SelectedIndex = null;
      else p2SelectedIndex = null;
      
      updateUI();
    }
  }



  function checkStuck() {
     const allHands = [...p1Hand, ...p2Hand].filter(c => c !== null); // 空スロットを除外してチェック
    const canPlay = allHands.some(c => 
      isPlayable(c.num, field.left.num) || isPlayable(c.num, field.right.num)
    );

    if (!canPlay) {
      startStuckRecovery();
    }
  }


  // 手詰まり解消のカウントダウン
  async function startStuckRecovery() {
    const msgEl = document.getElementById('control-panel');
    const textEl = document.getElementById('msg');
    msgEl.style.display = 'block';
    
    // カウントダウン演出
    for (let i = 3; i > 0; i--) {
      textEl.textContent = `出せる札がありません！ ${i}`;
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    textEl.textContent = "ゴー！";
    
     // 山札があればそこから、なければ手札の最初の1枚を場に出す（手詰まり解消）
    if (p1Deck.length > 0) {
      field.left = p1Deck.shift();
    } else {
      const p1Available = p1Hand.findIndex(c => c !== null);
      if (p1Available !== -1) {
        field.left = p1Hand[p1Available];
        p1Hand[p1Available] = null;
      }
    }

    if (p2Deck.length > 0) {
      field.right = p2Deck.shift();
    } else {
      const p2Available = p2Hand.findIndex(c => c !== null);
      if (p2Available !== -1) {
        field.right = p2Hand[p2Available];
        p2Hand[p2Available] = null;
      }
    }


      setTimeout(() => {
      msgEl.style.display = 'none';
      updateUI();
      // 復旧させた後にまた詰まってないか確認
      setTimeout(checkStuck, 500);
    }, 500);






  function isPlayable(card, target) {
    const diff = Math.abs(card - target);
    return diff === 1 || diff === 12;
  }

  function animateField(side) {
    const suffix = (side === 'left') ? 'left' : 'right';
    const ids = [`p1-field-${suffix}`, `p2-field-${suffix}`];
    ids.forEach(id => {
      const el = document.getElementById(id);
      el.classList.add('pop');
      setTimeout(() => el.classList.remove('pop'), 200);
    });
  }
</script>
</body>
</html>
