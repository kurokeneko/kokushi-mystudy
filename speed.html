<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speed Card Game - 1vs1 Professional</title>
    <style>
        :root {
            --p1-color: #ff4757;
            --p2-color: #2e86de;
            --card-bg: #ffffff;
            --table-bg: #2f3542;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--table-bg);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* --- 画面構成 --- */
        .player-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
            padding: 10px;
            position: relative;
        }

        /* P2側は180度回転。手前に手札、奥に場札が来るレイアウト */
        #p2-area { 
            transform: rotate(180deg); 
            border-bottom: 2px dashed #57606f; 
        }

        /* --- カードのデザイン --- */
        .card {
            width: 60px;
            height: 90px;
            background: var(--card-bg);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
            position: relative;
        }

        .card.red { color: #ff4757; }
        .card.black { color: #2f3542; }

        .card.selected {
            transform: translateY(-15px) scale(1.1);
            box-shadow: 0 0 15px #f1c40f;
            border: 3px solid #f1c40f;
        }

        .card.highlight {
            animation: pulse 0.8s infinite;
            box-shadow: 0 0 20px #2ecc71;
            border: 2px solid #2ecc71;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* --- 手札と山札 --- */
        .hand { display: flex; gap: 10px; height: 100px; }
        .deck-info { color: white; font-size: 12px; margin-top: 5px; opacity: 0.7; }

        /* --- 場札エリア --- */
        .field { display: flex; gap: 30px; }
        .field-slot {
            width: 60px;
            height: 90px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        /* --- カウントダウン表示 --- */
        #overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            font-size: 120px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="overlay"></div>

    <div class="player-area" id="p2-area">
        <div class="field">
            <div class="field-slot" id="p2-field-L"></div>
            <div class="field-slot" id="p2-field-R"></div>
        </div>
        <div class="hand" id="p2-hand"></div>
        <div class="deck-info">山札: <span id="p2-deck-count">22</span></div>
    </div>

    <div class="player-area" id="p1-area">
        <div class="field">
            <div class="field-slot" id="p1-field-L"></div>
            <div class="field-slot" id="p1-field-R"></div>
        </div>
        <div class="hand" id="p1-hand"></div>
        <div class="deck-info">山札: <span id="p1-deck-count">22</span></div>
    </div>

    <script>
        const suits = ['♠', '♥', '♦', '♣'];
        const values = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13];
        const valMap = { 1: 'A', 11: 'J', 12: 'Q', 13: 'K' };

        let deck = [];
        let p1Hand = [], p2Hand = [], p1Deck = [], p2Deck = [];
        let fieldCards = [null, null]; // [0]: 左, [1]: 右
        let selectedIdx = null;
        let activePlayer = null;
        let isStuck = false; // 出せるカードがない状態

        function initGame() {
            deck = [];
            suits.forEach(s => values.forEach(v => deck.push({ suit: s, val: v })));
            deck.sort(() => Math.random() - 0.5);

            p1Deck = deck.slice(0, 26);
            p2Deck = deck.slice(26, 52);
            
            p1Hand = p1Deck.splice(0, 4);
            p2Hand = p2Deck.splice(0, 4);
            
            fieldCards[0] = p1Deck.pop();
            fieldCards[1] = p2Deck.pop();

            checkStuck();
            render();
        }

        function getCardText(card) {
            return (valMap[card.val] || card.val) + card.suit;
        }

        function isRed(suit) { return suit === '♥' || suit === '♦'; }

        function canPlace(cardVal, targetVal) {
            const diff = Math.abs(cardVal - targetVal);
            return diff === 1 || diff === 12; // 1と13のループ対応
        }

        function render() {
            updateHand('p1', p1Hand);
            updateHand('p2', p2Hand);
            updateField();
            document.getElementById('p1-deck-count').innerText = p1Deck.length;
            document.getElementById('p2-deck-count').innerText = p2Deck.length;
        }

        function updateHand(playerId, hand) {
            const container = document.getElementById(`${playerId}-hand`);
            container.innerHTML = '';
            hand.forEach((card, idx) => {
                const div = document.createElement('div');
                div.className = `card ${isRed(card.suit) ? 'red' : 'black'}`;
                if (activePlayer === playerId && selectedIdx === idx) div.classList.add('selected');
                div.innerText = getCardText(card);
                div.onclick = () => selectCard(playerId, idx);
                container.appendChild(div);
            });
        }

        function updateField() {
            ['p1', 'p2'].forEach(p => {
                ['L', 'R'].forEach((side, idx) => {
                    const slot = document.getElementById(`${p}-field-${side}`);
                    slot.innerHTML = '';
                    const card = fieldCards[idx];
                    const cardDiv = document.createElement('div');
                    cardDiv.className = `card ${isRed(card.suit) ? 'red' : 'black'}`;
                    cardDiv.innerText = getCardText(card);
                    
                    if (selectedIdx !== null) {
                        if (isStuck) {
                            // 詰み状態：自分から見て右側（idx 1）だけを光らせる
                            if (idx === 1) {
                                cardDiv.classList.add('highlight');
                                cardDiv.onclick = () => resetByManualCard(idx);
                            }
                        } else if (canPlace(getPlayerHand()[selectedIdx].val, card.val)) {
                            // 通常時：ルール通り出せる場所を光らせる
                            cardDiv.classList.add('highlight');
                            cardDiv.onclick = () => playCard(idx);
                        }
                    }
                    slot.appendChild(cardDiv);
                });
            });
        }

        function selectCard(playerId, idx) {
            if (activePlayer === playerId && selectedIdx === idx) {
                selectedIdx = null;
                activePlayer = null;
            } else {
                activePlayer = playerId;
                selectedIdx = idx;
            }
            render();
        }

        function getPlayerHand() { return activePlayer === 'p1' ? p1Hand : p2Hand; }
        function getPlayerDeck() { return activePlayer === 'p1' ? p1Deck : p2Deck; }

        function playCard(fieldIdx) {
            const hand = getPlayerHand();
            const deck = getPlayerDeck();
            
            fieldCards[fieldIdx] = hand[selectedIdx];
            if (deck.length > 0) {
                hand[selectedIdx] = deck.pop();
            } else {
                hand.splice(selectedIdx, 1);
            }

            if (hand.length === 0) {
                alert(activePlayer.toUpperCase() + " WIN!");
                initGame();
                return;
            }

            selectedIdx = null;
            activePlayer = null;
            checkStuck();
            render();
        }

        // 詰み判定
        function checkStuck() {
            const p1CanMove = p1Hand.some(c => canPlace(c.val, fieldCards[0].val) || canPlace(c.val, fieldCards[1].val));
            const p2CanMove = p2Hand.some(c => canPlace(c.val, fieldCards[0].val) || canPlace(c.val, fieldCards[1].val));
            isStuck = (!p1CanMove && !p2CanMove);
        }

        // 手動で1枚出して仕切り直し
        async function resetByManualCard(fieldIdx) {
            const hand = getPlayerHand();
            const deck = getPlayerDeck();
            
            fieldCards[fieldIdx] = hand[selectedIdx];
            if (deck.length > 0) {
                hand[selectedIdx] = deck.pop();
            } else {
                hand.splice(selectedIdx, 1);
            }
            
            selectedIdx = null;
            activePlayer = null;
            isStuck = false;
            render();

            await startCountdown();
        }

        async function startCountdown() {
            const overlay = document.getElementById('overlay');
            overlay.style.display = 'flex';
            for (let i = 3; i > 0; i--) {
                overlay.innerText = i;
                await new Promise(r => setTimeout(r, 500));
            }
            overlay.style.display = 'none';
            
            // カウントダウン後に両方の山札から補充して強制変更
            if (p1Deck.length > 0) fieldCards[0] = p1Deck.pop();
            if (p2Deck.length > 0) fieldCards[1] = p2Deck.pop();
            
            checkStuck();
            render();
        }

        initGame();
    </script>
</body>
</html>
